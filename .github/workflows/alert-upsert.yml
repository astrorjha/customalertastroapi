name: Rewire DAG failure alert to last committer
on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  ORG_ID: ${{ secrets.ASTRO_ORG_ID }}
  DEPLOY_ID: ${{ secrets.ASTRO_DEPLOY_ID }}
  ASTRO_API_TOKEN: ${{ secrets.ASTRO_API_TOKEN }}

jobs:
  alert:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: meta
        name: Capture committer email
        run: |
          set -euxo pipefail
          echo "▶ GITHUB_ACTOR = $GITHUB_ACTOR"
          # Always pull the author email from GitHub’s commit API
          AUTHOR_EMAIL=$(gh api \
            /repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA} \
            -q .commit.author.email)
          echo "▶ Resolved AUTHOR_EMAIL = $AUTHOR_EMAIL"
          echo "AUTHOR_EMAIL=$AUTHOR_EMAIL" >> "$GITHUB_ENV"

      - name: Upsert channel
        run: |
          set -euxo pipefail
          echo "▶ ORG_ID        = $ORG_ID"
          echo "▶ DEPLOY_ID     = $DEPLOY_ID"
          echo "▶ ASTRO_API_TOKEN len = ${#ASTRO_API_TOKEN}"
          echo "▶ AUTHOR_EMAIL  = $AUTHOR_EMAIL"

          # Fetch all channels (increase limit to avoid pagination)
          ALL_CH=$(curl -s -H "Authorization: Bearer $ASTRO_API_TOKEN" \
            "https://api.astronomer.io/platform/v1beta1/organizations/$ORG_ID/notification-channels?limit=100")
          echo "▶ All channels JSON:"
          echo "$ALL_CH" | jq .

          # Try to find an existing channel for this deployment+email
          CID=$(echo "$ALL_CH" | jq -r --arg dep "$DEPLOY_ID" --arg email "$AUTHOR_EMAIL" '
            .notificationChannels[]
            | select(
                .entityId == $dep and
                (.definition.recipients[]? == $email)
              )
            | .id // empty'
          )

          if [ -z "$CID" ]; then
            echo "▶ No existing channel found—creating one"
            CREATE_RESP=$(curl -s -X POST -H "Authorization: Bearer $ASTRO_API_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                    "name": "demo-'${AUTHOR_EMAIL}'",
                    "type": "EMAIL",
                    "entityType": "DEPLOYMENT",
                    "entityId": "'${DEPLOY_ID}'",
                    "definition": { "recipients": ["'${AUTHOR_EMAIL}'"] }
                  }' \
              "https://api.astronomer.io/platform/v1beta1/organizations/$ORG_ID/notification-channels")
            echo "▶ Create response:"
            echo "$CREATE_RESP" | jq .
            CID=$(echo "$CREATE_RESP" | jq -r '.id')
          else
            echo "▶ Found existing channel ID: $CID"
          fi

          echo "▶ Final CHAN_ID = $CID"
          echo "CHAN_ID=$CID" >> "$GITHUB_ENV"

      - name: Upsert alert
        run: |
          set -euxo pipefail
          echo "▶ ASTRO_API_TOKEN len = ${#ASTRO_API_TOKEN}"
          echo "▶ ORG_ID              = $ORG_ID"
          echo "▶ DEPLOY_ID           = $DEPLOY_ID"
          echo "▶ CHAN_ID             = $CHAN_ID"

          # Fetch all alerts
          ALL_ALERTS=$(curl -s -H "Authorization: Bearer $ASTRO_API_TOKEN" \
            "https://api.astronomer.io/platform/v1beta1/organizations/$ORG_ID/alerts?limit=100")
          echo "▶ All alerts JSON:"
          echo "$ALL_ALERTS" | jq .

          # Look for our DAG_FAILURE alert on this deployment
          ALERT_ID=$(echo "$ALL_ALERTS" | jq -r --arg dep "$DEPLOY_ID" '
            .alerts[]
            | select(
                .name == "auto-committer-failure" and
                ((.entityId // .deploymentId) == $dep)
              )
            | .id // empty'
          )

          ALERT_PAYLOAD='{
            "entityId": "'${DEPLOY_ID}'",
            "entityType": "DEPLOYMENT",
            "name": "auto-committer-failure",
            "type": "DAG_FAILURE",
            "severity": "CRITICAL",
            "notificationChannelIds": ["'${CHAN_ID}'"],
            "rules": { "properties": { "deploymentId": "'${DEPLOY_ID}'" } }
          }'
          echo "▶ ALERT_PAYLOAD:"
          echo "$ALERT_PAYLOAD" | jq .

          if [ -z "$ALERT_ID" ]; then
            echo "▶ Creating new alert"
            curl -s -X POST -H "Authorization: Bearer $ASTRO_API_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$ALERT_PAYLOAD" \
              "https://api.astronomer.io/platform/v1beta1/organizations/$ORG_ID/alerts" \
            | jq .
          else
            echo "▶ Patching existing alert ID: $ALERT_ID"
            curl -s -X PATCH -H "Authorization: Bearer $ASTRO_API_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$ALERT_PAYLOAD" \
              "https://api.astronomer.io/platform/v1beta1/organizations/$ORG_ID/alerts/$ALERT_ID" \
            | jq .
          fi